<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
	<title>Corine Land Cover map</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css">

	<style>
		#changeSlider {
			border-radius: 0;
			width: 300px;
		}

		#changeSlider .noUi-handle {
			border-radius: 0;
			background: #2980b9;
			height: 18px;
			width: 18px;
			top: -1px;
			right: -9px;
		}
	</style>

</head>

<body style="font-family: sans-serif;">

	<div id="map" style="position:relative; height:600px; width:900px;">

		<div style="
                font-size: 0.9em;
                position: absolute;
                left: 10px;
                top: 10px;
                width: auto;
                height: auto;
                padding: 5px;
                border: 0px;
                border-radius: 5px;
                background: #ffffffcc;
                line-height: 1.6;
                box-shadow: 3px 3px 3px grey, -3px -3px 3px #ddd;
            ">
			<div>
				<select id="layer">
					<option value="clc2018" selected>2018</option>
					<option value="clc2012">2012</option>
					<option value="clc2006">2006</option>
					<option value="clc2000">2000</option>
					<option value="clc1990">1990</option>
					<option value="change">Change</option>
					<option value="change_art">Change - artificialisation</option>
				</select>
			</div>
			<div id="sliderDiv">
				<div style="padding: 14px; height: 45px;">
					<div id="changeSlider"></div>
				</div>
			</div>
		</div>

		<div
			style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
			<span style="font-size: 0.8em; font-family: sans-serif;"><a target="_blank"
					rel="nofollow noreferrer noopener" href="https://github.com/eurostat/gridviz"
					style="text-decoration:none">GridViz</a> |
				&#169; <a target="_blank" rel="nofollow noreferrer noopener" href="https://eurogeographics.org"
					style="text-decoration:none">EuroGeographics</a> |
				&#169; <a target="_blank" rel="nofollow noreferrer noopener" href="https://www.tuik.gov.tr"
					style="text-decoration:none">Turkstat</a>
			</span>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/gridviz@3.0.20"></script>
	<script src="https://cdn.jsdelivr.net/npm/gridviz-parquet@1.1.0"></script>
	<script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@2.0.3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1"></script>

	<script>

		const map = new gridviz.Map(document.getElementById('map'), {
			x: 4030000,
			y: 2950000,
			z: 180,
		}).addZoomButtons()

		const clcYears = [1990, 2000, 2006, 2012, 2018]

		const clcDataset = {}
		for (const year of clcYears)
			clcDataset[year] = new gridviz.MultiResolutionDataset(
				[100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
				(resolution) => new gviz_par.TiledParquetGrid(map, 'https://raw.githubusercontent.com/eurostat/LCMap/main/pub/clc/v1/' + year + '/' + resolution + '/')
			)

		const changeDataset = new gridviz.MultiResolutionDataset(
			[100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
			(resolution) => new gviz_par.TiledParquetGrid(map, 'https://raw.githubusercontent.com/eurostat/LCMap/main/pub/clc/v1/change/' + resolution + '/')
		)

		//define colors for categories
		const clcColors = {
			1: '#e6004d',
			2: '#ff0000',
			3: '#cc4df2',
			4: '#cc0000',
			5: '#e6cccc',
			6: '#e6cce6',
			7: '#a600cc',
			8: '#a64d00',
			9: '#ff4dff',
			10: '#ffa6ff',
			11: '#ffe6ff',
			12: '#ffffa8',
			13: '#ffff00',
			14: '#e6e600',
			15: '#e68000',
			16: '#f2a64d',
			17: '#e6a600',
			18: '#e6e64d',
			19: '#ffe6a6',
			20: '#ffe64d',
			21: '#e6cc4d',
			22: '#f2cca6',
			23: '#80ff00',
			24: '#00a600',
			25: '#4dff00',
			26: '#ccf24d',
			27: '#a6ff80',
			28: '#a6e64d',
			29: '#a6f200',
			30: '#e6e6e6',
			31: '#cccccc',
			32: '#ccffcc',
			33: '#000000',
			34: '#a6e6cc',
			35: '#a6a6ff',
			36: '#4d4dff',
			37: '#ccccff',
			38: '#e6e6ff',
			39: '#a6a6e6',
			40: '#00ccf2',
			41: '#80f2e6',
			42: '#00ffa6',
			43: '#a6ffe6',
			44: '#e6f2ff',
			48: 'gray',
		}

		const artificial = [1, 2, 3, 4, 5, 6, 11]

		//define labels for categories
		const clcLabels = {
			1: 'Continuous urban fabric',
			2: 'Discontinuous urban fabric',
			3: 'Industrial or commercial units',
			4: 'Road and rail networks and associated land',
			5: 'Port areas',
			6: 'Airports',
			7: 'Mineral extraction sites',
			8: 'Dump sites',
			9: 'Construction sites',
			10: 'Green urban areas',
			11: 'Sport and leisure facilities',
			12: 'Non-irrigated arable land',
			13: 'Permanently irrigated land',
			14: 'Rice fields',
			15: 'Vineyards',
			16: 'Fruit trees and berry plantations',
			17: 'Olive groves',
			18: 'Pastures',
			19: 'Annual crops associated with permanent crops',
			20: 'Complex cultivation patterns',
			21: 'Land principally occupied by agriculture with significant areas of natural vegetation',
			22: 'Agro-forestry areas',
			23: 'Broad-leaved forest',
			24: 'Coniferous forest',
			25: 'Mixed forest',
			26: 'Natural grasslands',
			27: 'Moors and heathland',
			28: 'Sclerophyllous vegetation',
			29: 'Transitional woodland-shrub',
			30: 'Sands',
			31: 'Bare rocks',
			32: 'Sparsely vegetated areas',
			33: 'Burnt areas',
			34: 'Glaciers and perpetual snow',
			35: 'Inland marshes',
			36: 'Peat bogs',
			37: 'Salt marshes',
			38: 'Salines',
			39: 'Intertidal flats',
			40: 'Water courses',
			41: 'Water bodies',
			42: 'Coastal lagoons',
			43: 'Estuaries',
			44: 'Sea and ocean',
			48: 'No data',
		}

		//define style
		let blend = true

		const clcStyle = new gridviz.SquareColorCategoryWebGLStyle({
			code: (cell) => cell.code,
			color: clcColors,
			visible: (z) => z >= 25,
			blendOperation: (z) => blend ? 'multiply' : 'source-over',
		})

		const clcSideStyle = new gridviz.SideCategoryStyle({
			code: (cell) => cell.code,
			color: clcColors,
			width: (side, r, z) => z * 3,
			visible: (z) => z < 25,
		})
		const clcStyle2 = new gridviz.ShapeColorSizeStyle({
			color: (cell) => clcColors[cell.code] + "33",
			visible: (z) => z < 25,
			blendOperation: (z) => blend ? 'multiply' : 'source-over',
		})


		//define background layers
		const backgroundLayer1 = new gridviz.BackgroundLayer({
			url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
			resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
			origin: [0, 6000000],
			filterColor: () => '#ffffffc0',
			visible: (z) => z > 40,
		})
		const backgroundLayer2 = new gridviz.BackgroundLayer(
			gridviz_eurostat.giscoBackgroundLayer('OSMPositronBackground', 18, 'EPSG3035', {
				visible: (z) => z <= 40,
			})
		)

		//define boundaries layer
		const boundariesLayer = new gridviz.GeoJSONLayer(gridviz_eurostat.getEurostatBoundariesLayer())
		//make labels layer
		const labelLayer = new gridviz.LabelLayer(gridviz_eurostat.getEuronymeLabelLayer('EUR', '20'))


		var slider = document.getElementById('changeSlider');
		const slidersRange = {
			'min': 1990,
			'25%': 2000,
			'50%': 2006,
			'75%': 2012,
			'max': 2018
		}
		noUiSlider.create(slider, {
			range: slidersRange,
			start: [2006, 2012],
			margin: 1,
			behaviour: 'drag',
			connect: true,
			snap: true,
			//tooltips: [{ to: v => v }, { to: v => v }],
			pips: {
				mode: 'steps',
				stepped: true,
				density: 100
			},
		});
		var sliderDiv = document.getElementById('sliderDiv');



		const update = () => {
			const layer = document.querySelector('#layer').value

			sliderDiv.style.display = ["change", "change_art"].includes(layer) ? "inline" : "none"

			if (layer.startsWith("clc")) {
				const ds = clcDataset[+layer.replace("clc", "")]
				const clcLayer = new gridviz.GridLayer(ds, [clcStyle, clcStyle2, clcSideStyle], { minPixelsPerCell: 0.8, cellInfoHTML: (cell) => clcLabels[cell.code] })
				map.layers = [backgroundLayer1, backgroundLayer2, clcLayer, boundariesLayer, labelLayer]
			} else if (layer.startsWith("change")) {
				let [y1, y2] = slider.noUiSlider.getPositions();
				y1 = slidersRange[y1 == 0 ? "min" : y1 + "%"]
				y2 = slidersRange[y2 == 100 ? "max" : y2 + "%"]

				if (y1 >= y2) {
					map.layers = [backgroundLayer1, backgroundLayer2, boundariesLayer, labelLayer]
				} else {
					year1 = "code" + y1
					year2 = "code" + y2

					let changeStyle = undefined
					let cellInfoHTML = undefined
					if (layer == "change") {

						//define style
						changeStyle = new gridviz.SquareColorCategoryWebGLStyle({
							code: (c) => c[year2],
							color: clcColors,
							//visible: (z) => z >= 25,
							filter: (c) => c[year1] != c[year2]
						})

						cellInfoHTML = (c) => {
							const a = c[year1], b = c[year2]
							if (a == b) return "No change<br>" + clcLabels[a] + " (code " + a + ")"
							return "Change<br>" + y1 + ": " + clcLabels[a] + " (code " + a + ")<br>" + y2 + ": "
								+ clcLabels[b] + " (code " + b + ")"
						}
					} else if (layer == "change_art") {
						const artif = (c) => artificial.includes(c[year2]) && !artificial.includes(c[year1])
						//define style
						changeStyle = new gridviz.SquareColorCategoryWebGLStyle({
							code: (c) => 0,
							color: { 0: "red" },
							//visible: (z) => z >= 25,
							filter: artif
						})

						cellInfoHTML = (c) => {
							const a = c[year1], b = c[year2]
							if (a == b) return "No change<br>" + clcLabels[a] + " (code " + a + ")"
							const art = artif(c)
							return (art ? "Artificialisation" : "No artificialisation") + "<br>" + y1 + ": " + clcLabels[a] + " (code " + a + ")<br>" + y2 + ": "
								+ clcLabels[b] + " (code " + b + ")"
						}
					}

					const lay = new gridviz.GridLayer(changeDataset, [changeStyle], {
						minPixelsPerCell: 0.8, cellInfoHTML: cellInfoHTML,
					})
					map.layers = [backgroundLayer1, backgroundLayer2, lay, boundariesLayer, labelLayer]

				}
			} else map.layers = [backgroundLayer1, backgroundLayer2, boundariesLayer, labelLayer]

			map.redraw()
		}

		document.querySelector('#layer').addEventListener('change', update)
		slider.noUiSlider.on("slide", update);

		window.addEventListener('keydown', function (e) {
			if (e.key == "a") { blend = !blend; update() }
		}, false);

		update()

	</script>

</body>

</html>
