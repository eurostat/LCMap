<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
	<title></title>
</head>

<body style="font-family: sans-serif;">

	<div id="map" style="position:relative; height:600px; width:900px;">

		<div style="position: absolute;
                left: 10px;
                top: 10px;
                width: auto;
                height: auto;
                padding: 5px;
            ">
			<select id="layer">
				<option value="du2021" selected>Degree of urbanisation 2021</option>
				<option value="du2011">Degree of urbanisation 2011</option>
				<option value="chdu2011_2021">Degree of urbanisation 2011-2021 change</option>
				<option value="pop2021">Population 2021</option>
				<option value="pop2011">Population 2011</option>
				<option value="clc2018">Corine land cover 2018</option>
				<option value="clc2012">Corine land cover 2012</option>
			</select><br>
		</div>

		<div
			style="position: absolute; right: 0px; bottom: 0px; width: auto; height: auto; padding: 1px; border: 0px; background: #FFFFFFCC;">
			<span style="font-size: 0.8em; font-family: sans-serif;"><a target="_blank"
					rel="nofollow noreferrer noopener" href="https://github.com/eurostat/gridviz"
					style="text-decoration:none">GridViz</a> |
				&#169; <a target="_blank" rel="nofollow noreferrer noopener" href="https://eurogeographics.org"
					style="text-decoration:none">EuroGeographics</a> |
				&#169; <a target="_blank" rel="nofollow noreferrer noopener" href="https://www.tuik.gov.tr"
					style="text-decoration:none">Turkstat</a>
			</span>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/gridviz@3.0.20"></script>
	<script src="https://cdn.jsdelivr.net/npm/gridviz-parquet@1.1.0"></script>
	<script src="https://cdn.jsdelivr.net/npm/gridviz-eurostat@2.0.3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
	<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>

	<script>

		const map = new gridviz.Map(document.getElementById('map'), {
			x: 4030000,
			y: 2950000,
			z: 180,
		}).addZoomButtons()

		// degurba dataset

		const degurbaYears = [2011, 2021]
		const degUrbaDataset = new gridviz.MultiResolutionDataset([1000, 2000, 5000, 10000],
			(resolution) => new gviz_par.TiledParquetGrid(map, 'https://raw.githubusercontent.com/eurostat/LCMap/main/pub/degurba/v1/' + resolution + "/"), {
			preprocess: c => {
				//console.log(c)
				if (!c.du2011) c.du2011 = 0
				if (!c.du2021) c.du2021 = 0
			}
		}
		)

		/*
		30 - Urban centre (255 0 0) #FF0000
		23 - Dense Urban cluster (115 38 0)  #732600
		22 - Semi-dense Urban cluster (168 112 0) #A87000
		21- Suburban cluster (255 255 0) #FFFF00
		13 - Rural cluster (55 86 35) #375623
		12 - Low density rural grid cell (171 205 102) #ABCD66
		11- Very low density Urban grid cell (205 245 122) #CDF57A
		10 â€“ Water (122 182 245) #7AB6F5
		*/

		const degurbaCodeToText = {
			30: "Urban centre",
			23: "Dense Urban cluster",
			22: "Semi-dense Urban cluster",
			21: "Suburban cluster",
			13: "Rural cluster",
			12: "Low density rural grid cell",
			11: "Very low density Urban grid cell",
			10: "Water",
			0: "No data",
		}


		const degurbaCodeToColour = {
			30: "#FE0000",
			23: "#732600",
			22: "#A87000",
			21: "#FFFF00",
			13: "#375623",
			12: "#ABCD66",
			11: "#CDF57A",
			10: "#7AB6F5",
			0: "#eee",
		}

		/*
		const degurbaCodeToColourBright = Object.fromEntries(
			Object.entries(degurbaCodeToColour).map(([key, value]) => [key,
			//d3.color(value).brighter(2)
			d3.color(value).copy({opacity: 0.05})
		])
		)
		const degurbaCodeToColourDark = Object.fromEntries(
			Object.entries(degurbaCodeToColour).map(([key, value]) => [key, 
			//d3.color(value).darker(2)
			value
		])
		)*/




		const popYears = [2006, 2011, 2018, 2021]

		//define multi resolution dataset
		const popDataset = {}
		for (const year of popYears)
			popDataset[year] = new gridviz.MultiResolutionDataset(
				[1000, 2000, 5000, 10000, 20000, 50000, 100000],
				(resolution) => new gviz_par.TiledParquetGrid(map, 'https://raw.githubusercontent.com/jgaffuri/tiled-popgrid/main/pub/v1/' + year + '/' + resolution + '/')
			)

		const popScale = gridviz.logarithmicScale(-7)
		const popStyle = new gridviz.ShapeColorSizeStyle({
			viewScale: (cells) => d3.max(cells, c => c.p),
			color: (cell, resolution, z, max) => d3.interpolateYlOrRd(popScale((+cell.p) / (max))),
			alpha: (z) => (z < 100 ? 0.75 : undefined),
			blendOperation: (z) => z < 100 ? 'multiply' : 'source-over',
		})
		const popStrokeStyle = new gridviz.StrokeStyle({
			strokeColor: () => 'gray',
			strokeWidth: (c, r, z) => r * 0.04,
			visible: (z) => z < 100,
		})



		const clcYears = [1990, 2000, 2006, 2012, 2018]

		//define clc multi resolution datasets
		const clcDataset = {}
		for (const year of clcYears)
			clcDataset[year] = new gridviz.MultiResolutionDataset(
				[100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
				(resolution) => new gviz_par.TiledParquetGrid(map, 'https://raw.githubusercontent.com/eurostat/LCMap/main/pub/clc/v1/' + year + '/' + resolution + '/')
			)


		//define colors for categories
		const clcColors = {
			1: '#e6004d',
			2: '#ff0000',
			3: '#cc4df2',
			4: '#cc0000',
			5: '#e6cccc',
			6: '#e6cce6',
			7: '#a600cc',
			8: '#a64d00',
			9: '#ff4dff',
			10: '#ffa6ff',
			11: '#ffe6ff',
			12: '#ffffa8',
			13: '#ffff00',
			14: '#e6e600',
			15: '#e68000',
			16: '#f2a64d',
			17: '#e6a600',
			18: '#e6e64d',
			19: '#ffe6a6',
			20: '#ffe64d',
			21: '#e6cc4d',
			22: '#f2cca6',
			23: '#80ff00',
			24: '#00a600',
			25: '#4dff00',
			26: '#ccf24d',
			27: '#a6ff80',
			28: '#a6e64d',
			29: '#a6f200',
			30: '#e6e6e6',
			31: '#cccccc',
			32: '#ccffcc',
			33: '#000000',
			34: '#a6e6cc',
			35: '#a6a6ff',
			36: '#4d4dff',
			37: '#ccccff',
			38: '#e6e6ff',
			39: '#a6a6e6',
			40: '#00ccf2',
			41: '#80f2e6',
			42: '#00ffa6',
			43: '#a6ffe6',
			44: '#e6f2ff',
			48: 'gray',
		}

		//define labels for categories
		const clcLabels = {
			1: 'Continuous urban fabric',
			2: 'Discontinuous urban fabric',
			3: 'Industrial or commercial units',
			4: 'Road and rail networks and associated land',
			5: 'Port areas',
			6: 'Airports',
			7: 'Mineral extraction sites',
			8: 'Dump sites',
			9: 'Construction sites',
			10: 'Green urban areas',
			11: 'Sport and leisure facilities',
			12: 'Non-irrigated arable land',
			13: 'Permanently irrigated land',
			14: 'Rice fields',
			15: 'Vineyards',
			16: 'Fruit trees and berry plantations',
			17: 'Olive groves',
			18: 'Pastures',
			19: 'Annual crops associated with permanent crops',
			20: 'Complex cultivation patterns',
			21: 'Land principally occupied by agriculture with significant areas of natural vegetation',
			22: 'Agro-forestry areas',
			23: 'Broad-leaved forest',
			24: 'Coniferous forest',
			25: 'Mixed forest',
			26: 'Natural grasslands',
			27: 'Moors and heathland',
			28: 'Sclerophyllous vegetation',
			29: 'Transitional woodland-shrub',
			30: 'sands',
			31: 'Bare rocks',
			32: 'Sparsely vegetated areas',
			33: 'Burnt areas',
			34: 'Glaciers and perpetual snow',
			35: 'Inland marshes',
			36: 'Peat bogs',
			37: 'Salt marshes',
			38: 'Salines',
			39: 'Intertidal flats',
			40: 'Water courses',
			41: 'Water bodies',
			42: 'Coastal lagoons',
			43: 'Estuaries',
			44: 'Sea and ocean',
			48: 'No data',
		}

		//define style
		const clcStyle = new gridviz.SquareColorCategoryWebGLStyle({
			code: (cell) => cell.code,
			color: clcColors,
			visible: (z) => z >= 25,
		})

		const clcSideStyle = new gridviz.SideCategoryStyle({
			code: (cell) => cell.code,
			color: clcColors,
			width: (side, r, z) => z * 3,
			visible: (z) => z < 25,
		})
		const clcStyle2 = new gridviz.ShapeColorSizeStyle({
			color: (cell) => clcColors[cell.code] + "33",
			visible: (z) => z < 25,
		})



		//define background layers
		const backgroundLayer1 = new gridviz.BackgroundLayer({
			url: 'https://raw.githubusercontent.com/jgaffuri/mbxyz/main/pub/elevation_shading/',
			resolutions: Array.from({ length: 9 }, (_, i) => 28.00132289714475 * Math.pow(2, 10 - i)),
			origin: [0, 6000000],
			filterColor: () => '#ffffffc0',
			visible: (z) => z > 40,
		})
		const backgroundLayer2 = new gridviz.BackgroundLayer(
			gridviz_eurostat.giscoBackgroundLayer('OSMPositronBackground', 18, 'EPSG3035', {
				visible: (z) => z <= 40,
			})
		)

		//define boundaries layer
		const boundariesLayer = new gridviz.GeoJSONLayer(gridviz_eurostat.getEurostatBoundariesLayer())
		//make labels layer
		const labelLayer = new gridviz.LabelLayer(gridviz_eurostat.getEuronymeLabelLayer('EUR', '20'))


		const update = () => {
			const layer = document.querySelector('#layer').value

			if (layer.startsWith("du")) {

				const degurbaStyle = new gridviz.SquareColorCategoryWebGLStyle({
					code: (cell) => cell[layer],
					color: degurbaCodeToColour,
					visible: (z) => z >= 150,
					filter: (cell) => cell[layer] != '0' //&& cell[layer] != '10',
				})

				const degurbaSideStyle = new gridviz.SideCategoryStyle({
					code: (cell) => cell[layer],
					color: degurbaCodeToColour,
					width: (side, r, z) => z * 3,
					visible: (z) => z < 150,
				})
				const degurbaStyle2 = new gridviz.ShapeColorSizeStyle({
					color: (cell) => degurbaCodeToColour[cell[layer]] + "33",
					visible: (z) => z < 150,
				})

				//make grid layer
				const year = +layer.replace("du", "")
				const degurbaLayer = new gridviz.GridLayer(degUrbaDataset, [degurbaStyle, degurbaStyle2, degurbaSideStyle], {
					minPixelsPerCell: 1,
					cellInfoHTML: (cell) => degurbaCodeToText[cell[layer]] + " (code " + cell[layer] + ")",
				})

				map.layers = [degurbaLayer, boundariesLayer, labelLayer]
				//TODO continue checking that
				//map.layers = [backgroundLayer1, backgroundLayer2, degurbaLayer, boundariesLayer, labelLayer]
			}
			else if (layer == "chdu2011_2021") {

				/*const degurbaStyle = new gridviz.SquareColorCategoryWebGLStyle({
					code: (cell) => cell.du2021,
					color: degurbaCodeToColourBright,
					//visible: (z) => z >= 150,
					filter: (cell) => cell.du2021
				})*/

				//d3.color("steelblue").brighter(1)

				const degurbaChangeStyle = new gridviz.SquareColorCategoryWebGLStyle({
					code: (cell) => cell.du2021,
					color: degurbaCodeToColour,
					//visible: (z) => z >= 150,
					filter: (cell) => cell.du2021 && cell.du2011 != cell.du2021 //&& cell[layer] != '10',
				})

				const degurbaLayer = new gridviz.GridLayer(degUrbaDataset, [/*degurbaStyle,*/ degurbaChangeStyle], {
					minPixelsPerCell: 1,
					cellInfoHTML: (c) => {
						const a = c.du2011, b = c.du2021
						if (!b) return
						if (a == b) return "No change<br>" + degurbaCodeToText[c.du2021] + " (code " + c.du2021 + ")"
						return "Change<br>2011: " + degurbaCodeToText[c.du2011] + " (code " + c.du2011 + ")<br>2021: "
							+ degurbaCodeToText[c.du2021] + " (code " + c.du2021 + ")"
					},
				})

				map.layers = [degurbaLayer, boundariesLayer, labelLayer]

			} else if (layer.startsWith("pop")) {
				const year = +layer.replace("pop", "")
				const ds = popDataset[year]
				const popLayer = new gridviz.GridLayer(ds, [popStyle, popStrokeStyle], { minPixelsPerCell: 1, cellInfoHTML: (cell) => cell.p })
				map.layers = [backgroundLayer1, backgroundLayer2, popLayer, boundariesLayer, labelLayer]
			}
			else if (layer.startsWith("clc")) {
				const ds = clcDataset[+layer.replace("clc", "")]
				const clcLayer = new gridviz.GridLayer(ds, [clcStyle, clcStyle2, clcSideStyle], { minPixelsPerCell: 0.8, cellInfoHTML: (cell) => clcLabels[cell.code] })
				map.layers = [backgroundLayer1, backgroundLayer2, clcLayer, boundariesLayer, labelLayer]
			}
			else map.layers = [backgroundLayer1, backgroundLayer2, boundariesLayer, labelLayer]

			map.redraw()
		}

		document.querySelector('#layer').addEventListener('change', update)

		update()

	</script>

</body>

</html>